javascripture.modules.reference={load:function(e){var t=this,n=e.book,r=e.chapter,i=e.verse;"undefined"==typeof i&&(e.verse=1);e.rightVersion=$("#versionSelectorRight").val();e.rightVersion==="original"&&localStorage.rightVersion&&(e.rightVersion=localStorage.rightVersion);e.leftVersion=$("#versionSelectorLeft").val();e.leftVersion==="original"&&localStorage.leftVersion&&(e.leftVersion=localStorage.leftVersion);worker.postMessage({task:"reference",parameters:e});return this},scrollToVerse:function(e,t){undefined===t&&(t=0);$(document).scrollTop(0);t-=$("#dock").height();$("html").hasClass("reading-mode")&&(t-=50);e.length>0&&$(document).scrollTo(e,{offset:t});$(document).trigger("createWayPoint")},getAnchoringData:function(e){var t="#current",n=0,r=$(document).scrollTop(),i;if(e){e==="prev"&&(i=$(".reference:first-child ol.wrapper li:first-child"));e==="next"&&(i=$(".reference:last-child ol.wrapper li:last-child"));t="#"+i.attr("id");i.length?n=r-i.offset().top+$("#dock").height():n=r+$("#dock").height()}return[n,t]},anchorReference:function(e){var t=e[1],n=e[0],r=$(t),i;if(t===".current-verse"){i=r.height();n=-$(window).height()/2+i}if(r.length===0){r=$("#"+e.currentId);n=-$("[data-role=header]").height()}this.scrollToVerse(r,n)},getReferenceFromCurrentUrl:function(){return this.getReferenceFromUrl(window.location.hash)},getReferenceFromUrl:function(e){var t=e.split("&"),n={};if(t.length>1){n.book=t[0].split("=")[1];n.chapter=parseInt(t[1].split("=")[1],10);n.verse=1;t[2]&&(n.verse=parseInt(t[2].split("=")[1],10))}return n},loadReferenceFromHash:function(){var e=window.location.hash;if(e.indexOf("search")>-1){var t=e.split("=")[1];setTimeout(function(){createSearchReferencesPanel({lemma:t})})}else{var n=this.getReferenceFromHash();localStorage&&(localStorage.reference=JSON.stringify(n));n.anchoringData=javascripture.modules.reference.getAnchoringData(null);javascripture.modules.reference.load(n)}},getReferenceFromHash:function(){var e=window.location.hash.split("/"),t=e[1],n=parseInt(e[2],10),r=1;e[3]&&(r=parseInt(e[3],10));return{book:t,chapter:n,verse:r}},createReferenceLink:function(e){return"/"+e.book+"/"+e.chapter+"/"+e.verse},getChapterText:function(e,t){var n=this,r=t.book,i=t.chapter,s=t.verse,o=i-1,u=s-1,a=!1,f='<div class="reference frequencyAnalysis" data-book="'+r+'" data-chapter="'+i+'"><h1>'+r+" "+i+"</h1>";f+='<ol class="wrapper">';t&&t.right&&t.right.forEach(function(s,o){f+=n.getVerseString(e,t,r,i,s,o,u)});f+="</ol>";f+="</div>";return f},getVerseString:function(e,t,n,r,i,s,o){var u=this,a="";a+='<li id="'+n.replace(/ /gi,"_")+"_"+r+"_"+(s+1)+'"';s===o&&(a+=' class="current"');a+='data-verse="'+(s+1)+'">';a+='<div class="wrapper"';s===o&&(a+=' id="current"');if(s===o-5){a+=' id="context"';context=!0}a+=">";a+='<div class="right '+e.rightVersion+" "+e.testament+'">';t.right[s].forEach(function(t,n){t&&(a+=u.createWordString(t,e.testament,e.rightVersion))});a+="</div>";if(t.left&&t.left[s]){a+="<div class='left "+e.leftVersion+" "+e.testament+"'>";t.left[s].forEach(function(t,n){t&&(a+=u.createWordString(t,e.testament,e.leftVersion))});a+="</div>"}a+="</div>";a+="</li>";return a},createWordString:function(e,t,n){var r=this,i="",s=[],o,u,a="";if(typeof e[1]=="undefined")return"<span>"+e[0]+"</span> ";null===e[0]?wordDisplayArray=[""]:n==="original"||n==="lc"?wordDisplayArray=e[0].split(/\//g):wordDisplayArray=[e[0]];u=e[1].split(/\//g);morph=[];e[2]&&(morph=e[2].split(/ |\//g));wordDisplayArray.forEach(function(e,r){s=[];var o="",a,f;if(u&&u[r]){a=u[r];s.push(javascripture.api.word.getFamily(a))}i+="<span";i+=' class="'+s.join(" ")+"-family "+a+" searchable"+'"';i+=' title="'+a;morph&&(i+=" "+morph);i+='"';i+=' data-word="'+e+'"';a&&(i+=' data-lemma="'+a+'"');i+=' data-language="'+t+'"';i+=' data-range="verse"';i+=' data-family="'+s.join(" ")+'"';if(morph&&"undefined"!=typeof morph[r]){f=morph[r];i+=' data-morph="'+f+'"'}i+=">";if(n==="lc"){var l="";"undefined"!=typeof f&&(l=f.replace(/\-/g,""));i+=javascripture.modules.translateLiterally.getByLemmaAndMorph(a,l)}else i+=e;i+="</span>";n==="lc"&&(i+=" ")});return'<span class="word">'+i+"</span> "}};(function(e){var t=javascripture.data.english;e.fn.scrollStopped=function(t){e(this).scroll(function(){var n=this,r=e(n);r.data("scrollTimeout")&&clearTimeout(r.data("scrollTimeout"));r.data("scrollTimeout",setTimeout(t,250,n))})};javascripture.modules.reference.loadReferenceFromHash();e(window).bind("hashchange",function(){var e=new Date;javascripture.modules.reference.loadReferenceFromHash();var t=new Date;timer(e,t)});e(window).scrollStopped(function(){var t=e(document).scrollTop(),n=e(".referencePanel").height()-e(window).height(),r;if(t<=0){var i=e(".three-references").data("prev");if(i){i.anchoringData=javascripture.modules.reference.getAnchoringData("prev");javascripture.modules.reference.load(i)}}if(t>=n){var s=e(".three-references").data("next");if(s){s.anchoringData=javascripture.modules.reference.getAnchoringData("next");javascripture.modules.reference.load(s)}}});e(".goToReference").submit(function(t){t.preventDefault();var n=bible.parseReference(e("#goToReference").val());setHashState(bible.Data.books[n.bookID-1][0],n.chapter,n.verse);e(this).closest(".popup").popup("close");e("#goToReference").blur();e("html").hasClass("reading-mode")&&hideDock();return!1});worker.addEventListener("message",function(t){if(t.data.task==="reference"){var n=t.data.result.reference,r='<div class="three-references"';t.data.result.prev&&(r+=" data-prev='"+JSON.stringify(t.data.result.prev)+"'");t.data.result.next&&(r+=" data-next='"+JSON.stringify(t.data.result.next)+"'");r+=">";t.data.result.chapters.forEach(function(e){r+=javascripture.modules.reference.getChapterText(t.data.result,e)});r+="</div>";e("#verse").html(r);var i=n.book;typeof n.chapter!="undefined"&&(i+=" "+n.chapter);typeof n.verse!="undefined"&&(i+=":"+n.verse);e("head title").text(i);e.fn.waypoint&&e(".reference").waypoint("destroy");javascripture.modules.reference.anchorReference(t.data.parameters.anchoringData);maintainState(n)}});worker.addEventListener("message",function(t){t.data.task==="loading"&&e(".loading").html(t.data.html)})})(jQuery);